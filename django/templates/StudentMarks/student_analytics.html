<!--
    SPDX-License-Identifier: AGPL-3.0-or-later
    Copyright (C) 2023 Julian Lapenna
-->
{% extends "base/base.html" %}
{% load static %}
{% load custom_tags %}
{% block page_heading %}
Analytics
{% endblock page_heading %}
{% block main_content %}
<!DOCTYPE html>
<meta charset="utf-8">
<script src="https://d3js.org/d3.v7.js"></script>

{% for question, scores in student_analytics.items %}
<!-- Create div where the graph will take place -->
<div id="d3_plotting_histogram_{{ forloop.counter }}"></div>
<br>
<br>
<br>
<script>
    // set the dimensions and margins of the graph
    var margin = { top: 10, right: 30, bottom: 30, left: 40 },
        width = 460 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;

    // append the svg object to the body of the page
    var svg = d3.select("#d3_plotting_histogram_{{ forloop.counter }}")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");

    var data = {% autoescape off %}{{ scores | safe }}{% endautoescape %};

    var x = d3.scaleLinear()
        .domain([-0.5, d3.max(data, function(d) { return +d })+0.5])     // can use this instead of 1000 to have the max of data: d3.max(data, function(d) { return +d })
        .range([0, width]);
    svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x));

    // set the parameters for the histogram
    var histogram = d3.histogram()
        .value(function (d) { return d; })   // I need to give the vector of value
        .domain(x.domain())  // then the domain of the graphic
        .thresholds(x.ticks(d3.max(data, function(d) { return +d }))); // then the numbers of bins

    // And apply this function to flattenedData to get the bins
    var bins = histogram(data);

    // Y axis: scale and draw:
    var y = d3.scaleLinear()
        .range([height, 30]);
    y.domain([0, d3.max(bins, function (d) { return d.length; })]);   // d3.hist has to be called before the Y axis obviously
    svg.append("g")
        .call(d3.axisLeft(y));

    // append the bar rectangles to the svg element
    svg.selectAll("rect")
        .data(bins)
        .enter()
        .append("rect")
        .attr("x", 1)
        .attr("transform", function (d) { return "translate(" + x(d.x0-0.5) + "," + y(d.length) + ")"; })
        .attr("width", function (d) { return x(d.x1) - x(d.x0) - 1; })
        .attr("height", function (d) { return height - y(d.length); })
        .style("fill", "#69b3a2");

		//Create Title 
    svg.append("text")
		.attr("x", width / 2 )
        .attr("y", 10)
        .style("text-anchor", "middle")
        .text("Marks for Q{{ question }}");

    // Define X axis function
    var xAxis = d3.axisBottom(x);

    // Define Y axis function
    var yAxis = d3.axisLeft(y);

    //Create X axis	
    svg.append("g")
        .attr("class", "axis x")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);

    //Create X axis label   
    svg.append("text")
		.attr("x", width / 2 )
        .attr("y",  height + margin.bottom)
        .style("text-anchor", "middle")
        .text("Marks");

    //Create Y axis
    svg.append("g")
		   .attr("class", "axis y")
		   .call(yAxis);

    //Create Y axis label
    svg.append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 0-margin.left)
        .attr("x",0 - (height / 2))
        .attr("dy", "1em")
        .style("text-anchor", "middle")
        .text("# of Students");
</script>
{% endfor %}
{% endblock main_content %}